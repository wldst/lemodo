
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>表单字段管理</title>
<link rel="stylesheet"
	href="/static/plugin/bootstrap/css/bootstrap.min.css" />
<link href="/static/layui/css/layui.css" rel="stylesheet" />
</head>
<body>
	<form class="layui-form" id="editFormField" lay-filter="editFormField">
	<input id="instanceId" type="hidden">
		<div class="layui-form-item">
			<label class="layui-form-label">编码</label>
			<div class="layui-input-inline">
				<input name="id" class="layui-input" id="id" placeholder="请输入编码"
					autocomplete="off">
			</div>
			<label class="layui-form-label">表单ID</label>
			<div class="layui-input-inline">
				<input name="formId" class="layui-input" id="formId"
					placeholder="请输入表单ID" autocomplete="off">
			</div>
			<label class="layui-form-label">代码</label>
			<div class="layui-input-inline">
				<input name="code" class="layui-input" id="code" placeholder="请输入代码"
					autocomplete="off">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">名称</label>
			<div class="layui-input-inline">
				<input name="name" class="layui-input" id="name" placeholder="请输入名称"
					autocomplete="off">
			</div>
			<label class="layui-form-label">类型</label>
			<div class="layui-input-inline">
				<input name="type" class="layui-input" id="type" placeholder="请输入类型"
					autocomplete="off">
			</div>			
			<label class="layui-form-label">关联类</label>
			<div class="layui-input-inline">
			<input type=hidden  id="selectMapedPo" value="Po" />
				<input type="button" name="mapedPo" id="mapedPo"
					class="layui-btn layui-btn-primary " value="选择"
					lay-event="selectWindow"></input>
			</div>
		</div>
		<div class="layui-form-item">
		
		    <label class="layui-form-label">对象</label>
			<div class="layui-input-inline">
				<input type="button" class="layui-btn layui-btn-primary"
			    id="mapedObj" value="关联对象" />
			    <input type=hidden  id="selectMapedObj" value="Po" />
			</div>
			<label class="layui-form-label">列：</label>
			<div class="layui-input-inline">
				<select name="mapedCol" id="mapedCol" placeholder="请输入列" ></select>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-input-block">
				<button class="layui-btn" lay-submit lay-filter="submit-form">提交</button>
				<button type="reset" class="layui-btn layui-btn-primary">重置</button>
			</div>
		</div>
	</form>
	<br />
	<fieldset class="layui-elem-field layui-field-title"
		style="margin-top: 50px;">
		<legend>表单字段详情</legend>
	</fieldset>
	<div class="layui-input-inline" hidden=true>
		<input id="instanceIdReload">
	</div>
	<!-- lay-allowclose="false" -->
	<div class="layui-tab layui-tab-brief"
		lay-filter="FormFieldtabList" id="FormFieldtabList"></div>
	
<script id="FormFielddetail" type="text/html">
  <ul class="layui-tab-title" lay-filter="FormFieldTab" id="FormFieldTabHead">
    <li class="layui-this" lay-id="1" >数据列表</li>
	<li lay-id="2">关系管理</li>
  </ul>
  <div class="layui-tab-content" id="FormFieldTabContent">
    <div class="layui-tab-item layui-show"><div>
		<div class="demoTable">
			<form class="layui-form" action="">
				<div class="layui-form-item"> <label  class="layui-form-label" >名称</label>	<div class="layui-input-inline">		<input name="nameReload" class="layui-input" id="nameReload"			placeholder="请输入名称" autocomplete="off" >	</div></div>
				<div class="layui-row">
				    <div class="layui-col-xs3"><div class="grid-demo grid-demo-bg1"><div class="grid-demo">
				      <button class="layui-btn" lay-submit lay-filter="searchDO"
								data-type="reload">
								搜索<i class="layui-icon">&#xe615;</i>
							</button>
					   </div></div>
				    </div>
				    <div class="layui-col-xs3">
				      
				    </div>
			  </div>
			</form>
		</div>
		<table id="tableFormField" lay-filter="tableFormField"></table>
	</div></div>
    <div class="layui-tab-item"><div>
		<form class="layui-form" action="">
			<div class="layui-form-item">
				<div hidden=true id="selectPo" value="Po"></div>
				<div hidden=true id="selectObj"></div>
				
				<label class="layui-form-label">关系编码</label>
				<div class="layui-input-inline">
					<input class="layui-input" id="relationCode"
						placeholder="请输入领域对象名称" />
				</div>
				<label class="layui-form-label">关系名称</label>
				<div class="layui-input-inline">
					<input class="layui-input" id="relationName"
						placeholder="请输入领域对象名称" />
				</div>
			</div>
			<div  class="layui-form-item">
				<div class="layui-inline ">
					<label class="layui-form-label">选择关系</label>
					<div class="layui-input-inline">
						<select id="FormFieldExistRelation" lay-filter="FormFieldExistRelation"></select>
					</div>
				</div>
				<input type="button" class="layui-btn layui-btn-primary"
					id="relationPo" value="关联类" />
				<input type="button" class="layui-btn layui-btn-primary"
				    id="relationObj" value="关联实例" />
				<input type="button" class="layui-btn layui-btn-primary"
				    id="tansferObj" value="关联多实例" />
			</div>

			<div class="site-demo-button">
				<input type="button" class="layui-btn" id="relationSave"
					value="保存关系" />
					<input type="button" class="layui-btn" id="relationDel"
					value="删除关系" />
			</div>
		</form>
	</div></div>
  </div>
</script>
	<script src="/static/plugin/jQuery/jquery-2.2.3.min.js"></script>
	<script src="/static/plugin/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/layui/layui.js"></script>
	<script src="/static/util.js"></script>
	<script id="barDemo" type="text/html">
<button type="button" class="layui-btn layui-btn-sm layui-btn-radius" lay-event="del">
    <i class="layui-icon">&#xe640;</i>
  </button><a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="documentOpt">档案</a>
<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>		
</script>
	<script type="text/javascript">
	var currentNode;
	var stepTable;
	
 var layer,form,table,crudTable;
 layui.config({ dir: '/static/layui/',version: false ,debug: false,base: '/static/layui/lay/modeules/'}).use(['form','table','element'], function(){
 form = layui.form
  ,table = layui.table
  ,layer = layui.layer;
 var element = layui.element;

	table.on('row(tableFormField)', function(obj){
		  currentNode=obj.data;
	})
	window.openWindow = function (url,name){
		var data=currentNode;
		var width='65%';
	if(data.size>7){
		width='80%';
	}
		  layer.open({
		      type: 2,
		      anim: 0,
		      shade: 0,
		      title: name,
		      area: [width, '55%'],
		      btn:['关闭'],
		      yes:function(index,layero)
		      {
		      	var body = layer.getChildFrame('body', index);
				close()
		          //index为当前层索引
		        layer.close(index)
		      },
		      cancel:function(){//右上角关闭毁回调
		     	 close()
		     	 var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
		  		parent.layer.close(index); //再执行关闭
		      },
		      zIndex: layer.zIndex //重点1
		      ,success: function(layero, index){
		        layer.setTop(layero); //重点2
		   	  var body = layer.getChildFrame('body', index);
		   	 var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
		   	 iframeWin.initForm(data)
		      },
		      content: url
		  });
	}
	var getTpl = $("#FormFielddetail").html();
	$("#FormFieldtabList").html(getTpl);

		  stepTable = table.render({
			    elem: '#tableFormField'
			    ,method: 'POST' //方式
			    ,url:'[(${MODULE_NAME})]/cruder/FormField/query'
				,where: {
					name: $('#nameReload').val(),
					formId: $('#instanceLabelReload').val()				
				 }
			    ,dataType: 'json'
			    ,contentType:'application/json;charset=UTF-8'
			    ,toolbar: true
			    ,title: '数据表'
			    ,id: 'tableFormField'
			    ,cols: [ [
			    	{type:'checkbox', fixed: 'left'}			    	
			     		,{field:'id', title:'编码',sort: true}			    	
			     		,{field:'formId', title:'表单ID',sort: true}			    	
			     		,{field:'code', title:'代码',sort: true}			    	
			     		,{field:'name', title:'名称',sort: true}			    	
			     		,{field:'mapedPo', title:'类',sort: true}			    	
			     		,{field:'mapedObj', title:'对象',sort: true}			    	
			     		,{field:'mapedCol', title:'列',sort: true}
			    		,{fixed: 'right', title:'操作', align:'center', toolbar: '#barDemo',unresize: false, width: 260}
			    ] ]
			    ,page: true
			    ,done: fixRightTool
			    ,parseData: parseTableData
			  });
		//表单取值
		form.on('submit(edit[(${label})])', function(data){
			formSubmit();
		 return false;
		});
		function formSubmit(){
			 var formData={};
			 
			  formData['id']= $('#id').val();
			  formData['formId']= $('#formId').val();
			  formData['code']= $('#code').val();
			  formData['name']= $('#name').val();
			  formData['mapedPo']= $('#mapedPo').val();
			  formData['mapedObj']= $('#mapedObj').val();
			  formData['mapedCol']= $('#mapedCol').val();
			 var genurl = "[(${MODULE_NAME})]/cruder/FormField/save";
			 $.ajax({
			    type: "post",
			    url: genurl,
				dataType : "json",
				contentType : "application/json;charset=UTF-8",      
				data: JSON.stringify(formData),
				success: function (d) {
					if(!d.status){
			  			   layer.alert(d.msg, {icon: 5})
			  		   }else{
			  			   layer.alert(d.msg, {icon: 6})
			  		   		refresh()
			  		   }
		      	},
		 		error:function (d) {
			        layer.alert(d.msg, {icon: 5})
			        refresh()
			    }
			    });
			}
		  
		  
		  //监听提交
		  form.on('submit(searchDO)', function(data){
		        //执行重载
		        stepTable.reload({
		          page: {
		            curr: 1 //重新从第 1 页开始
		          }
		          ,where: {
		        	  name: $('#nameReload').val(),
			          formId: $('#instanceLabelReload').val()
		          }
		        });
		    return true;
		  });
		  var endList={};
		  var tabIds={};
		  var rowi=null;	 
		  //监听表格复选框选择
		  table.on('checkbox(tableFormField)', function(obj){
		    //console.log(obj) 
		    $('#editFormField')[0].reset();		    
			    if($('#id').attr('type')=='checkbox'){
			    	if(obj.data['id']=='on'){
			    		$('#id').prop('checked','checked');
			    	}else  if(obj.data['id']=='off'){
				    	$('#id').prop('checked','');
				    }
			    }else{
			    	$('#id').val(obj.data['id']);
			    }	    	
			    if($('#formId').attr('type')=='checkbox'){
			    	if(obj.data['formId']=='on'){
			    		$('#formId').prop('checked','checked');
			    	}else  if(obj.data['formId']=='off'){
				    	$('#formId').prop('checked','');
				    }
			    }else{
			    	$('#formId').val(obj.data['formId']);
			    }	    	
			    if($('#code').attr('type')=='checkbox'){
			    	if(obj.data['code']=='on'){
			    		$('#code').prop('checked','checked');
			    	}else  if(obj.data['code']=='off'){
				    	$('#code').prop('checked','');
				    }
			    }else{
			    	$('#code').val(obj.data['code']);
			    }	    	
			    if($('#name').attr('type')=='checkbox'){
			    	if(obj.data['name']=='on'){
			    		$('#name').prop('checked','checked');
			    	}else  if(obj.data['name']=='off'){
				    	$('#name').prop('checked','');
				    }
			    }else{
			    	$('#name').val(obj.data['name']);
			    }	    	
			    if($('#mapedPo').attr('type')=='checkbox'){
			    	if(obj.data['mapedPo']=='on'){
			    		$('#mapedPo').prop('checked','checked');
			    	}else  if(obj.data['mapedPo']=='off'){
				    	$('#mapedPo').prop('checked','');
				    }
			    }else{
			    	$('#mapedPo').val(obj.data['mapedPo']);
			    }	    	
			    if($('#mapedObj').attr('type')=='checkbox'){
			    	if(obj.data['mapedObj']=='on'){
			    		$('#mapedObj').prop('checked','checked');
			    	}else  if(obj.data['mapedObj']=='off'){
				    	$('#mapedObj').prop('checked','');
				    }
			    }else{
			    	$('#mapedObj').val(obj.data['mapedObj']);
			    }	    	
			    if($('#mapedCol').attr('type')=='checkbox'){
			    	if(obj.data['mapedCol']=='on'){
			    		$('#mapedCol').prop('checked','checked');
			    	}else  if(obj.data['mapedCol']=='off'){
				    	$('#mapedCol').prop('checked','');
				    }
			    }else{
			    	$('#mapedCol').val(obj.data['mapedCol']);
			    }	    	
			 	    
		    form.render();
		    textEditorValue(obj.data);
		    currentNode=obj.data;
		    rowi=obj.data;
		    if(tabIds!=null){
		    	for(var tab in tabIds){
		    		element.tabDelete('FormFieldtabList',  tabIds[tab]);
		    	}
		    }
		    
		    //调用关系
		    objectRelation(obj.data);
		  });
		  function textEditorValue(data){
			  
		  }
		  
		  table.on('rowDouble(tableFormField)', function(obj){
			    //console.log(obj) $('#editFormField')[0].reset();
			    var width='65%';
			    if(obj.data.size>7){
			    	width='900px';
			    }
			    
				layer.open({
			      type: 2,
			      anim: 0,
			      shade: 0,
			      maxmin: true,
			      title: "编辑",
			      area: [width, '55%'],
			      btn:['关闭'],
			      full: function(a, b) {
			          	$(a).find('.layui-layer-content').css('height','100%');
			          	$(a).find('iframe').css('height','100%');
			          },
			      restore: function(a, b) {
			          	$(a).find('iframe').css('height','90%');
			          	$(a).find('.layui-layer-content').css('height','90%');
			          },
			      yes:function(index,layero)
			      {
			      	var body = layer.getChildFrame('body', index);
					close()
			          //index为当前层索引
			        layer.close(index)
			      },
			      cancel:function(){//右上角关闭毁回调
			     	 close()
			     	/*  var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
			  		parent.layer.close(index); //再执行关闭 */
			      },
			      zIndex: layer.zIndex //重点1
			      ,success: function(layero, index){
			        layer.setTop(layero); //重点2
			   	  var body = layer.getChildFrame('body', index);
			   	 var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
			   	 // console.log(body.html()) //得到iframe页的body内容
			   	 iframeWin.initForm(obj.data)
			   	// console.log(obj.data)
			   	  //body.find('input').val('Hi，我是从父页来的')
			      },
			      content: "[(${MODULE_NAME})]/layui/FormField/form/"+obj.data.id
			  });
			    form.render();
			    form.val('editFormField', obj.data);
			    textEditorValue(obj.data);
			    $('#formId').val($('#instanceId').val()); 
			    currentNode=obj.data;
		  });
		  
		  //监听工具条
		  table.on('tool(tableFormField)', function(obj){
		    var data = obj.data;
		    if(obj.event === 'del'){
		      layer.confirm('真的删除行么', function(index){
		        obj.del();
		        delDomain(obj)
		        layer.close(index);
		      });
		    }
		  });
		  
		  
		  getByInstanceId();
	 let isMainData=false;
	 // 监听单选框的选中事件
	 form.on('radio(isMainData)', function(data){
		 isMainData=data.value
	 });
	  /**
		 * 保存关系
		 */
		 layui.$('#relationSave').on('click',function (po){
			 var endLabel= $("#selectPo").val();
			 var endCode = $("#selectObj").val();
			 var relationCode = $("#relationCode").val();
			 var relationName = $("#relationName").val();
			 if(endCode==null||currentNode==null){
				 return;
			 }	
			 var startCode = currentNode.id;
			 
			 var genurl = "[(${MODULE_NAME})]/objectRel/FormField/"+endLabel+"/"+relationCode+"/save";
			 
			 var formData={};
			 var relations=new Array();
			 var relation={};
			 var relProp={};
			 relation['endId']=endCode;      
			 relation['startId']=startCode; 
			 relProp['label']=relationCode;
			 relProp['name']=relationName;
			 if(isMainData){
				 relProp['mainData']='true';
			 }
			 relation['startLabel']="FormField";
			 relation['endLabel']=endLabel;
			 relations[0]=relation;
			 formData['relations']=relations;
			 formData['relProp']=relProp;
			
			 $.ajax({
					type: "post",
					url: genurl,
					dataType : "json",
					contentType : "application/json;charset=UTF-8",      //
					data: JSON.stringify(formData),
					success: function (d) {
						if(!d.status){
				  			   layer.alert(d.msg, {icon: 5})
				  		   }else{
				  			   layer.alert(d.msg, {icon: 6})
				  		   	if(currentNode!=null){
					    		objectRelation(currentNode);
					    	}
				  		   }
					    
					},
					error:function (d) {
					      layer.alert(d.msg, {icon: 5})
					      refresh()
					}
			    });
		});

	//relationDel 删除关系
	layui.$('#relationDel').on('click',function (po){
			 var endLabel= $("#selectPo").val();
			 var endId = $("#selectObj").val();
			 var relationCode = $("#relationCode").val();
			 var relationName = $("#relationName").val();
			 var startCode = $("#id").val();
			 if(endId==null||startCode==null){
				 return;
			 }		
			 var genurl = "[(${MODULE_NAME})]/objectRel/FormField/"+endLabel+"/"+relationCode+"/del";
			 
			 var formData={};
			 var relations=new Array();
			 var relation={};
			 var relProp={};
			 relation['endId']=endId;      
			 relation['startId']=startCode; 
			 relProp['label']=relationCode;
			 relProp['name']=relationName;
			 relation['startLabel']="FormField";
			 relation['endLabel']=endLabel;
			 relations[0]=relation;
			 formData['relations']=relations;
			 formData['relProp']=relProp;
			//      
			//formData['endCode']=$('#poIdReload').val();      
			
			 $.ajax({
					type: "post",
					url: genurl,
					dataType : "json",
					contentType : "application/json;charset=UTF-8",      //
					data: JSON.stringify(formData),
					success: function (d) {
					    layer.alert(d.msg, {icon: 6})
					    if(currentNode!=null){
					    	objectRelation(currentNode);
					    }
					},
					error:function (d) {
					      layer.alert(d.msg, {icon: 5})
					      refresh()
					}
			    });
		});
		
		//关联多对象
		layui.$('#tansferObj').on('click', function(data){
		 var select= $("#selectPo").val();
		 var selectPoName = $("#relationPo").val();
		 var relationCode= $("#relationCode").val();
		 var relationName= $("#relationName").val();
		 //var startId = $("#id").val();
		  var startId = currentNode.id;
		 if(select==null||select==""){
			 $("#selectPo").val("Po");
			 select="Po"
		 }
		 layer.open({
	    type: 2,
	    anim: 0,
	    shade: 0,
	    title: "关联"+selectPoName,
	    area: ['650px', '600px'],
	    btn:['关闭'],
	    yes:function(index,layero)
	    {
	    	var body = layer.getChildFrame('body', index);
	    	var selected = body.find('#selectObj').val();
		    var selectedName = body.find('#selectObjName').val();		        	
	    	$("#relationObj").val(selectedName);
	    	$("#selectObj").val(selected);
				
					 close()
	        //index为当前层索引
	        layer.close(index)
	    },
	    cancel:function(){//右上角关闭毁回调
	   	 close()
	   	 var index = parent.layer.getFrameIndex(data.name); //先得到当前iframe层的索引
			parent.layer.close(index); //再执行关闭
	    },
	    zIndex: layer.zIndex //重点1
	    ,success: function(layero, index){
	      layer.setTop(layero); //重点2
	 	  var body = layer.getChildFrame('body', index);
	 	 // var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
	 	 // console.log(body.html()) //得到iframe页的body内容
	 	 //console.log(data)
	 	  //body.find('input').val('Hi，我是从父页来的')
	    },
	    content: "[(${MODULE_NAME})]/manage/transfer/[(${label})]/"+startId+"/"+relationCode+"/"+select
	});
	});
		
	//表单取值
	layui.$('#relationObj').on('click', function(data){
	 var select= $("#selectPo").val();
	 var selectPoName = $("#relationPo").val();
	 if(select==null||select==""){
		 $("#selectPo").val("MetaData");
		 select="MetaData"
	 }
	 layer.open({
	  type: 2,
	  anim: 0,
	  shade: 0,
	  title: "关联"+selectPoName,
	  area: ['95%', '95%'],
	  btn:['关闭'],
	  yes:function(index,layero)
	  {
	  	var body = layer.getChildFrame('body', index);
	  	var selected = body.find('#selectObj').val();
	    var selectedName = body.find('#selectObjName').val();
	        	
	  	$("#relationObj").val(selectedName);
	  	$("#selectObj").val(selected);
			
				 close()
	      //index为当前层索引
	      layer.close(index)
	  },
	  cancel:function(){//右上角关闭毁回调
	 	 close()
	 	 var index = parent.layer.getFrameIndex(data.name); //先得到当前iframe层的索引
			parent.layer.close(index); //再执行关闭
	  },
	  zIndex: layer.zIndex //重点1
	  ,success: function(layero, index){
	    layer.setTop(layero); //重点2
		  var body = layer.getChildFrame('body', index);
		 // var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
		 // console.log(body.html()) //得到iframe页的body内容
		 //console.log(data)
		  //body.find('input').val('Hi，我是从父页来的')
	  },
	  content: "[(${MODULE_NAME})]/objectRel/FormField/"+select
	});
});

	layui.$('#relationPo').on('click', function(data){
		  layer.open({
	        type: 2,
	        anim: 0,
	        shade: 0,
	        title: "选择",
	        area: ['95%', '95%'],
	        btn:['关闭'],
	        yes:function(index,layero)
	        {
	        	var body = layer.getChildFrame('body', index);
	        	var selected = body.find('#selectPo').val();
	        	var selectedName = body.find('#selectPoName').val();
	        	
	        	$("#selectPo").val(selected);
				//$("#selectPoName").text(selectedName);
				$("#relationPo").val(selectedName);
				close()
	            //index为当前层索引
	            layer.close(index)
	        },
	        cancel:function(){//右上角关闭毁回调
	       	 close()
	       	 var index = parent.layer.getFrameIndex(data.name); //先得到当前iframe层的索引
	    		parent.layer.close(index); //再执行关闭
	        },
	        zIndex: layer.zIndex //重点1
	        ,success: function(layero, index){
	          layer.setTop(layero); //重点2
	     	  var body = layer.getChildFrame('body', index);
	     	 // var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
	     	 // console.log(body.html()) //得到iframe页的body内容
	     	// console.log(data)
	     	  //body.find('input').val('Hi，我是从父页来的')
	        },
	        content: "[(${MODULE_NAME})]/vue/poSelect"
	    });
	});

		function addTab(tabId,title,content){
			element.tabDelete('FormFieldtabList', tabId);
			//新增一个Tab项
			element.tabAdd('FormFieldtabList', {
			        title: title 
			        ,content: content 
			        ,id: tabId 
			})
			element.tabChange('FormFieldtabList', tabId) 
		}

		function objectRelation(po){
			 var genurl = "[(${MODULE_NAME})]/cruder/FormField/tabList";
			 
			 $.ajax({
			      type: "post",
			      url: genurl,
			        dataType : "json",
			        contentType : "application/json;charset=UTF-8",      //
			        data: JSON.stringify(po),
			        success: function (d) {
						if(d.data) {
							var tabs = d.data.tabList;
							if (tabs.length > 0) {
								for (var tab in tabs) {
									addTab(tabs[tab].tabId, tabs[tab].tabTitle, tabs[tab].tabContent);
									tabIds[tab] = tabs[tab].tabId;
								}
							}

							endList = d.data.relationEnd;
							$("#FormFieldExistRelation").html(d.data.existRelation);
							form.render('select');
						}
			      	},
			 		error:function (d) {
				    }
			    });
		}
		
		form.on('select(FormFieldExistRelation)', function(data){
			$("#relationCode").val(data.value);
			 
			var sel = data.elem;
			for(var i in sel){
				if(parseInt(i)&&sel[i].value==data.value){
					$("#relationName").val(sel[i].label);
				}
			}
			
			if(endList!=null){
				var endNode=endList[data.value];
				
				$("#selectPo").val(endNode["label"]);
				//$("#selectPoName").text(selectedName);
				$("#relationPo").val(endNode["name"]);
			}
		})
		
		function poFieldSelect(data){
			  var genurl = "[(${MODULE_NAME})]/cruder/"+data+"/fieldList";
				 var formData={}
				 $.ajax({
				    type: "post",
				    url: genurl,
					dataType : "json",
					contentType : "application/json;charset=UTF-8",      
					data: JSON.stringify(formData),
					success: function (d) {
						var fileds=d.data;
						var vo= $("#mapedCol");
						vo.empty();
						for(var i in fileds){
							vo.append("<option value='"+fileds[i].code+"'>"+fileds[i].name+"</option>");
						}
						layui.form.render('select');
				          
			      	},
			 		error:function (d) {
				        layer.alert(d.msg, {icon: 5})
				    }
				  });
		}
		
		layui.$('#mapedObj').on('click', function(data){
			 var select= $("#selectMapedPo").val();
			 var selectPoName = $("#mapedPo").val();
			 if(select==null||select==""){
				 $("#selectPo").val("MetaData");
				 select="MetaData"
			 }
			 layer.open({
			  type: 2,
			  anim: 0,
			  shade: 0,
			  title: "关联"+selectPoName,
			  area: ['95%', '95%'],
			  btn:['关闭'],
			  yes:function(index,layero)
			  {
			  	var body = layer.getChildFrame('body', index);
			  	var selected = body.find('#selectObj').val();
			    var selectedName = body.find('#selectObjName').val();
			        	
			  	$("#mapedObj").val(selectedName);
			  	$("#selectMapedObj").val(selected);
			  	poFieldSelect(selected);
						 close()
			      //index为当前层索引
			      layer.close(index)
			  },
			  cancel:function(){//右上角关闭毁回调
			 	 close()
			 	 var index = parent.layer.getFrameIndex(data.name); //先得到当前iframe层的索引
					parent.layer.close(index); //再执行关闭
			  },
			  zIndex: layer.zIndex //重点1
			  ,success: function(layero, index){
			    layer.setTop(layero); //重点2
			  },
			  content: "[(${MODULE_NAME})]/objectRel/FormField/"+select
			});
			});
		
			layui.$('#mapedPo').on('click', function(data){
				  layer.open({
			        type: 2,
			        anim: 0,
			        shade: 0,
			        title: "选择",
			        area: ['95%', '95%'],
			        btn:['关闭'],
			        yes:function(index,layero)
			        {
			        	var body = layer.getChildFrame('body', index);
			        	var selected = body.find('#selectPo').val();
			        	var selectedName = body.find('#selectPoName').val();
			        	
			        	$("#selectMapedPo").val(selected);
						//$("#selectPoName").text(selectedName);
						$("#mapedPo").val(selectedName);
						close()
			            //index为当前层索引
			            layer.close(index)
			        },
			        cancel:function(){//右上角关闭毁回调
			       	 close()
			       	 var index = parent.layer.getFrameIndex(data.name); //先得到当前iframe层的索引
			    		parent.layer.close(index); //再执行关闭
			        },
			        zIndex: layer.zIndex //重点1
			        ,success: function(layero, index){
			          layer.setTop(layero); //重点2
			     	  var body = layer.getChildFrame('body', index);
			        },
			        content: "[(${MODULE_NAME})]/vue/poSelect"
			    });
			});
	  
	
});

	function getByInstanceId(){
		$('#formId').val($('#instanceId').val())
	      //执行重载
	      stepTable.reload({
	        page: {
	          curr: 1 //重新从第 1 页开始
	        }
	        ,where: {
	        	formId: $('#instanceId').val()
	        }
	      });
	}

	function delDomain(po){
		 var genurl = "[(${MODULE_NAME})]/cruder/FormField/del";
		 var vm=$("#tableFormField");
		 var formData=po.data;
		 
		 $.ajax({
		      type: "post",
		      url: genurl,
		        dataType : "json",
		        contentType : "application/json;charset=UTF-8",      //
		        data: JSON.stringify(formData),
		        success: function (d) {
		           layer.alert(d.msg, {icon: 6})
		           refresh()
		      	},
		 		error:function (d) {
			        layer.alert(d.msg, {icon: 5})
			        refresh()
			    }
		    });
	}

	function delRel(label,id){	
		 var genurl = "[(${MODULE_NAME})]/cruder/FormField/rel/"+label+"/del";
		 var formData={};
		 formData["endId"]=id;
		 formData["startId"]=currentNode.id;
		 $.ajax({
		      type: "post",
		      url: genurl,
		        dataType : "json",
		        contentType : "application/json;charset=UTF-8",      //
		        data: JSON.stringify(formData),
		        success: function (d) {
		           layer.alert(d.msg, {icon: 6})
		           $("#"+label+id).remove();
		           refresh()
		      	},
		 		error:function (d) {
			        layer.alert(d.msg, {icon: 5})
			        $("#"+label+id).remove();
			        refresh()
			    }
		 });
	}

	function refresh(){
		getByInstanceId();
	}
</script>
</body>
</html>